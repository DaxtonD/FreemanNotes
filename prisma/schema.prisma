generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             Int            @id @default(autoincrement())
  email          String         @unique
  name           String?
  passwordHash   String?
  role           String         @default("user")
  // Trash retention (0 = never auto-empty)
  trashAutoEmptyDays Int         @default(0)
  fontFamily     String?        @default("Calibri, system-ui, Arial, sans-serif")
  // Hyperlink colors (user-scoped across devices)
  linkColorDark  String?        @default("#8ab4f8")
  linkColorLight String?        @default("#0b57d0")
  // Note-card preferences (user-scoped across devices)
  disableNoteCardLinks Boolean?  @default(false)
  checkboxBg     String?
  checkboxBorder String?
  noteWidth      Int?           @default(288)
  checklistSpacing Int?         @default(15)
  checkboxSize     Int?         @default(20)
  checklistTextSize Int?        @default(17)
  noteLineSpacing  Float?       @default(1.38)
  dragBehavior   String?        @default("swap")
  animationSpeed String?        @default("normal")
  chipDisplayMode String?       @default("image+text")
  userImageUrl   String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  collaborations Collaborator[]
  invitesSent    Invite[]       @relation("InvitesSent")
  labels         Label[]
  notes          Note[]         @relation("OwnerNotes")
  notePrefs      NotePref[]
  collections    Collection[]
  noteCollections NoteCollection[]
  deviceProfiles UserDeviceProfile[]
  deviceClients  UserDeviceClient[]
  pushSubscriptions PushSubscription[]
}

// A per-user named device profile (e.g. "Pixel 8", "Work Laptop").
// Multiple browser installs on the same physical device can map to the same profile.
model UserDeviceProfile {
  id         Int               @id @default(autoincrement())
  userId     Int
  name       String
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  lastSeenAt DateTime          @default(now())
  user       User              @relation(fields: [userId], references: [id])
  prefs      UserDevicePrefs?
  clients    UserDeviceClient[]

  @@unique([userId, name])
  @@index([userId])
}

// A specific browser client installation/profile, keyed by a client-generated stable id.
model UserDeviceClient {
  id         Int               @id @default(autoincrement())
  userId     Int
  deviceKey  String
  profileId  Int
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  lastSeenAt DateTime          @default(now())
  user       User              @relation(fields: [userId], references: [id])
  profile    UserDeviceProfile @relation(fields: [profileId], references: [id])

  @@unique([userId, deviceKey])
  @@index([profileId])
  @@index([userId])
}

model UserDevicePrefs {
  id               Int               @id @default(autoincrement())
  profileId        Int               @unique
  themeChoice      String?           @default("system")
  checklistSpacing Int?
  checkboxSize     Int?
  checklistTextSize Int?
  noteLineSpacing  Float?
  // Note Card (device-scoped appearance)
  cardTitleSize           Int?
  cardChecklistSpacing    Int?
  cardCheckboxSize        Int?
  cardChecklistTextSize   Int?
  cardNoteLineSpacing     Float?
  // Note Editor (device-scoped appearance)
  editorChecklistSpacing  Int?
  editorCheckboxSize      Int?
  editorChecklistTextSize Int?
  editorNoteLineSpacing   Float?
  noteWidth        Int?
  fontFamily       String?
  dragBehavior     String?
  animationSpeed   String?
  animationBehavior String?
  animationsEnabled Boolean?         @default(true)
  chipDisplayMode  String?
  imageThumbSize   Int?
  editorImageThumbSize Int?          @default(115)
  editorImagesExpandedByDefault Boolean? @default(false)
  disableNoteCardLinks Boolean?       @default(false)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  profile          UserDeviceProfile @relation(fields: [profileId], references: [id])
}

model Invite {
  id          Int       @id @default(autoincrement())
  email       String
  token       String    @unique
  desiredRole String    @default("user")
  invitedById Int?
  usedAt      DateTime?
  createdAt   DateTime  @default(now())
  invitedBy   User?     @relation("InvitesSent", fields: [invitedById], references: [id])

  @@index([invitedById])
}

model Note {
  id            Int            @id @default(autoincrement())
  title         String?
  body          String?        @db.Text
  yData         Bytes?
  color         String?
  type          NoteType       @default(TEXT)
  ord           Int            @default(0)
  pinned        Boolean        @default(false)
  archived      Boolean        @default(false)
  // Trash (soft delete)
  trashedAt     DateTime?
  cardSpan      Int?           @default(1) // number of columns to span in grid (1, 2, or 3)
  // Reminders (shared per-note): due datetime and when to notify.
  reminderDueAt DateTime?
  reminderOffsetMinutes Int    @default(0)
  reminderAt    DateTime?
  // When a reminder notification was last fired (prevents duplicate pushes).
  reminderNotifiedAt DateTime?
  // URL preview (unfurl) footer
  linkPreviewUrl String?       @db.Text
  linkPreviewTitle String?     @db.Text
  linkPreviewDescription String? @db.Text
  linkPreviewImageUrl String?  @db.Text
  linkPreviewDomain String?
  linkPreviewFetchedAt DateTime?
  ownerId       Int
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  collaborators Collaborator[]
  owner         User           @relation("OwnerNotes", fields: [ownerId], references: [id])
  images        NoteImage[]
  items         NoteItem[]
  linkPreviews  NoteLinkPreview[]
  noteLabels    NoteLabel[]
  notePrefs     NotePref[]
  noteCollections NoteCollection[]

  @@index([ownerId])
  @@index([ownerId, trashedAt])
  @@index([ownerId, reminderAt])
  @@index([ownerId, reminderDueAt])
  @@map("Note")
}

model PushSubscription {
  id           Int      @id @default(autoincrement())
  userId       Int
  // Optional device key (from x-device-key) to help manage per-device subscriptions.
  deviceKey    String?  @db.VarChar(128)
  // Hash of endpoint for indexing/uniqueness (endpoints can be long TEXT).
  endpointHash String   @db.Char(64)
  endpoint     String   @db.Text
  p256dh       String   @db.Text
  auth         String   @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpointHash])
  @@index([userId])
  @@index([deviceKey])
}

model NoteLinkPreview {
  id          Int      @id @default(autoincrement())
  noteId      Int
  urlHash     String   @db.Char(64)
  url         String   @db.Text
  title       String?  @db.Text
  description String?  @db.Text
  imageUrl    String?  @db.Text
  domain      String?
  fetchedAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  note        Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([noteId, urlHash])
  @@index([noteId])
  @@index([urlHash])
}

model Collection {
  id        Int          @id @default(autoincrement())
  name      String
  ownerId   Int
  parentId  Int?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  owner     User         @relation(fields: [ownerId], references: [id])
  parent    Collection?  @relation("CollectionParent", fields: [parentId], references: [id], onDelete: Cascade)
  children  Collection[] @relation("CollectionParent")
  noteCollections NoteCollection[]

  @@unique([ownerId, parentId, name])
  @@index([ownerId])
  @@index([parentId])
}

// Per-user membership of a note in a collection (multi-collection support).
model NoteCollection {
  id           Int        @id @default(autoincrement())
  userId       Int
  noteId       Int
  collectionId Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  note         Note       @relation(fields: [noteId], references: [id], onDelete: Cascade)
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  @@unique([userId, noteId, collectionId])
  @@index([userId])
  @@index([noteId])
  @@index([collectionId])
}

model NoteItem {
  id      Int     @id @default(autoincrement())
  noteId  Int
  content String  @db.Text
  checked Boolean @default(false)
  indent  Int     @default(0)
  ord     Int     @default(0)
  note    Note    @relation(fields: [noteId], references: [id])

  @@index([noteId])
}

model NoteImage {
  id        Int      @id @default(autoincrement())
  noteId    Int
  url       String   @db.Text
  // OCR: raw extracted text
  ocrText   String?  @db.Text
  // OCR: normalized text optimized for search indexing
  ocrSearchText String? @db.Text
  // OCR: structured JSON output (blocks/lines/boxes/confidence)
  ocrDataJson String? @db.Text
  // OCR: sha256 hash of the source image bytes (used to avoid re-OCR)
  ocrHash   String?  @db.Char(64)
  // OCR: best-effort average confidence (0..1)
  ocrAvgConfidence Float?
  // OCR: language code used by PaddleOCR (default: "en")
  ocrLang   String?  @db.VarChar(16)
  // OCR: status string (e.g. pending|running|done|error|skipped)
  ocrStatus String?  @default("pending")
  ocrUpdatedAt DateTime?
  createdAt DateTime @default(now())
  note      Note     @relation(fields: [noteId], references: [id])

  @@index([noteId])
  @@index([ocrHash])
}

model Label {
  id         Int         @id @default(autoincrement())
  name       String
  ownerId    Int
  createdAt  DateTime    @default(now())
  owner      User        @relation(fields: [ownerId], references: [id])
  noteLabels NoteLabel[]

  @@unique([ownerId, name])
}

model NoteLabel {
  id      Int   @id @default(autoincrement())
  noteId  Int
  labelId Int
  label   Label @relation(fields: [labelId], references: [id])
  note    Note  @relation(fields: [noteId], references: [id])

  @@unique([noteId, labelId])
  @@index([labelId])
}

model Collaborator {
  id      Int      @id @default(autoincrement())
  noteId  Int
  userId  Int
  role    String   @default("editor")
  addedAt DateTime @default(now())
  note    Note     @relation(fields: [noteId], references: [id])
  user    User     @relation(fields: [userId], references: [id])

  @@index([noteId])
  @@index([userId])
}

model NotePref {
  id        Int      @id @default(autoincrement())
  noteId    Int
  userId    Int
  color     String?
  imagesExpanded Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  note      Note     @relation(fields: [noteId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([noteId, userId])
  @@index([noteId])
  @@index([userId])
}

enum NoteType {
  TEXT
  CHECKLIST
  IMAGE
}

