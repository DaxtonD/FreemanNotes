version: "3.8"
services:
  # Optional local MySQL database with persistent storage.
  # Enable with: `docker compose --profile with-db up --build`
  # Then set DATABASE_URL to use host `db`, e.g.:
  # DATABASE_URL="mysql://freeman:freemanpass@db:3306/freemannotes"
  db:
    image: mysql:8.4
    profiles: ["with-db"]
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: freemannotes
      MYSQL_USER: freeman
      MYSQL_PASSWORD: freemanpass
      MYSQL_ROOT_PASSWORD: rootpass
    command: ["--default-authentication-plugin=mysql_native_password"]
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  freemannotes:
    build: .
    ports:
      - "4000:4000"
    env_file:
      - .env
    environment:
      - OCR_SERVICE_URL=http://ocr:8080/ocr
      # Store uploads (avatars + note images). In Unraid, set UPLOADS_VOLUME to a host path
      # on the array (e.g. /mnt/user/...) to avoid using Docker's default data-root on cache.
      - UPLOADS_DIR=${UPLOADS_DIR:-/app/uploads}
    volumes:
      # If UPLOADS_VOLUME is an absolute path, this becomes a bind mount.
      # If UPLOADS_VOLUME is a name (default: uploads_data), this becomes a named volume.
      - ${UPLOADS_VOLUME:-uploads_data}:${UPLOADS_DIR:-/app/uploads}
    depends_on:
      - ocr
  ocr:
    build:
      context: .
      dockerfile: ocr-service/Dockerfile
    expose:
      - "8080"
    # MySQL is external; if you run MySQL in compose, add it here and adjust .env
    # networks:
    #   - appnet
#networks:
#  appnet:
#    driver: bridge

volumes:
  mysql_data:
  uploads_data:
